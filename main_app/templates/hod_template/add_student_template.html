{% extends 'main_app/base.html' %}
{% load static %}

{% block custom_css %}
<!-- âœ… Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
  .invalid {
    font-style: italic;
    font-weight: bold;
    color: red;
  }
  .valid {
    font-style: italic;
    font-weight: bold;
    color: green;
  }

  button[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Style for hidden course FIELD (the entire row) */
  .hidden-field {
    display: none !important;
  }
</style>
{% endblock custom_css %}

{% block page_title %}{{ page_title }}{% endblock page_title %}

{% block content %}
<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <!-- general form elements -->
        <div class="card card-dark">
          <div class="card-header">
            <h3 class="card-title">{{ page_title }}</h3>
          </div>

          <!-- âœ… Include your existing reusable form -->
          {% include "main_app/form_template.html" with messages=messages form=form button_text="Add Student" %}
        </div>
        <!-- /.card -->
      </div>
    </div>
  </div>
</section>
{% endblock content %}

{% block custom_js %}
<!-- âœ… Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function () {
  // âœ… Enable Select2 search on the school dropdown
  $('#id_school').select2({
    placeholder: 'Select or search for a school',
    allowClear: true,
    width: '100%',
  });

  // âœ… Enable Select2 on grade dropdown
  $('#id_grade').select2({
    placeholder: 'Select grade',
    allowClear: false,
    width: '100%',
  });

  // âœ… Enable Select2 on course dropdown
  $('#id_course').select2({
    placeholder: 'Select course',
    allowClear: true,
    width: '100%',
  });

  // ========== INSTANT GRADE-BASED COURSE FIELD TOGGLE ==========
  function toggleCourseField() {
    const gradeSelect = $('#id_grade');
    // Target the ENTIRE form field row (label + input + help text)
    const courseFieldRow = $('#id_course').closest('.form-group, .form-row, .mb-3');
    
    if (!gradeSelect.val()) {
      console.log('No grade selected');
      return;
    }

    // Get the selected grade text
    const selectedGrade = gradeSelect.find('option:selected').text();
    console.log('Selected grade:', selectedGrade);
    
    const youngGrades = ['Grade R', 'Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 
                        'Grade 5', 'Grade 6', 'Grade 7', 'Grade 8', 'Grade 9'];
    
    if (youngGrades.includes(selectedGrade)) {
      // HIDE THE ENTIRE COURSE FIELD ROW for young grades
      courseFieldRow.addClass('hidden-field');
      $('#id_course').val('').trigger('change');
      console.log(`ðŸŽ¯ HIDDEN entire course field for grade: ${selectedGrade}`);
    } else {
      // SHOW THE ENTIRE COURSE FIELD ROW for older grades
      courseFieldRow.removeClass('hidden-field');
      console.log(`ðŸŽ¯ SHOWED entire course field for grade: ${selectedGrade}`);
    }
    
    checkFormFilled();
  }

  // Initial toggle
  setTimeout(toggleCourseField, 100);

  // Toggle when grade changes
  $('#id_grade').on('change', toggleCourseField);

  // --- FORM VALIDATION ---
  const form = $("form");
  const addButton = form.find("button[type='submit']");
  addButton.prop("disabled", true);

  let emailValid = false;

  function validateEmail(email) {
    const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
  }

  function checkFormFilled() {
    let allFilled = true;
    
    // Check only VISIBLE required fields
    form.find("input, select, textarea").each(function () {
      const field = $(this);
      const isRequired = field.prop("required");
      const fieldRow = field.closest('.form-group, .form-row, .mb-3');
      const isVisible = !fieldRow.hasClass('hidden-field');
      
      // Skip if field is hidden
      if (!isVisible) return true;
      
      if (isRequired && !field.val()) {
        allFilled = false;
      }
    });

    if (allFilled && emailValid) {
      addButton.prop("disabled", false);
    } else {
      addButton.prop("disabled", true);
    }
  }

  $("#id_email").on("keyup change", function () {
    var email = $(this).val();
    if (validateEmail(email)) {
      $.ajax({
        url: "{% url 'check_email_availability' %}",
        type: "POST",
        data: { email: email },
      })
        .done(function (response) {
          $(".email_error").remove();
          if (response === "True") {
            $("<span class='invalid email_error'>Email Address Already Exists</span>").insertAfter("#id_email");
            emailValid = false;
          } else {
            $("<span class='valid email_error'>Email Address Available</span>").insertAfter("#id_email");
            emailValid = true;
          }
          checkFormFilled();
        })
        .fail(function () {
          $(".email_error").remove();
          $("<span class='invalid email_error'>Server Error â€” Try Again</span>").insertAfter("#id_email");
          emailValid = false;
          checkFormFilled();
        });
    } else {
      $(".email_error").remove();
      $("<span class='invalid email_error'>Invalid Email Format</span>").insertAfter("#id_email");
      emailValid = false;
      checkFormFilled();
    }
  });

  // Watch all form fields for changes
  form.find("input, select, textarea").on("keyup change", checkFormFilled);
  
  checkFormFilled();
});
</script>
{% endblock custom_js %}